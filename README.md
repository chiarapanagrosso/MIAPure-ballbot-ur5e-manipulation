# ü§ñ MIAPure ‚Äî Ballbot (UR5e) Manipulation Simulation

## Overview
This repository implements a complete simulation, planning and control framework for a **ballbot equipped with a UR5e manipulator** and a **Robotiq 2F-85 gripper**.  
The project explores *mobile manipulation on dynamically balancing platforms*, combining modeling, control, and motion planning techniques.

The work is inspired by the MIA-PURE research concept and aims to simulate the integration between a dynamically unstable **ballbot base** and a **6-DOF manipulator**, addressing challenges of stability, motion planning, and interaction.

The implemented framework integrates:
- Mathematical and Simscape-based dynamic models of the ballbot.
- Omnidirectional navigation and motion planning.
- Adaptive and model-based control strategies (LQR‚ÄìPI, MRAC, hybrid compensation).
- Manipulation planning through ROS 2 and MoveIt Task Constructor.
- Batch testing and post-processing tools for performance analysis.

---

## üéØ Introduction & Goals
The goal of the project is to study and simulate **mobile manipulation** on a ballbot platform ‚Äî a self-balancing robot whose dynamics resemble a 3D inverted pendulum.  
The main challenges addressed are:
- Stability control under actuation coupling.
- Robust motion and trajectory tracking during navigation.
- Coordinated manipulation with a mounted robotic arm.
- Integration between MATLAB/Simulink (for control) and ROS 2/MoveIt (for planning).

The repository includes everything needed to reproduce the simulations and analysis presented in the project report *‚ÄúFSR_Project_Rocco_Panagrosso.pdf‚Äù*.

---

## ‚öôÔ∏è Implemented Features

### 1. Dynamic Modeling
- Lagrangian derivation of the ballbot dynamics, decoupled into sagittal, frontal, and transverse planes.
- Torque mapping from three omni-wheels to equivalent planar torques.
- Open-loop validation of the derived equations using MATLAB simulations.
- Parameter identification consistent with the physical prototype specifications.

### 2. Control Architectures
Three control strategies are implemented and tested:

#### ‚Ä¢ Cascaded LQR‚ÄìPI Control
A linear‚Äìquadratic regulator computes optimal torques from the full-state model, while an inner PI loop compensates for unmodeled dynamics and friction.  
This controller ensures precise velocity tracking and stable balancing even in the presence of model mismatches.

#### ‚Ä¢ Model Reference Adaptive Control (MRAC)
An adaptive control scheme updates gains `K(t)`, `Kr(t)`, and `Ke(t)` in real time, allowing the ballbot to adapt to uncertainties such as changing payloads.  
The MRAC controller improves robustness at the cost of higher transient torques.

#### ‚Ä¢ Hybrid Compensated LQR‚ÄìPI
An enhanced version of the LQR‚ÄìPI controller that introduces a feedforward compensation based on equilibrium torque (`œÑ_EQ`) and tilt (`Œ∏_EQ`) estimation.  
This enables rejection of slow-varying external wrenches such as those generated by manipulator actions.

### üó∫Ô∏è 3. Motion Planning
- Implementation of **RRT\*** for path planning on a `binaryOccupancyMap` with obstacle inflation.
- Segment-wise trapezoidal or triangular velocity profiles for smooth motion.
- Lookahead feedback correction to improve tracking and reduce base tilt.
- Support for both 2D navigation and yaw control.

### 4. Manipulator Planning and Integration
- Integration of a **UR5e manipulator** imported from URDF into Simscape Multibody.
- Fixes and handling of **mimic joints** for gripper synchronization.
- **ROS 2 + MoveIt Task Constructor** pipeline for manipulation planning:
  - Symbolic HTN planner produces task sequences.
  - MoveIt MTC generates collision-free trajectories.
  - Joint trajectories are exported (rosbag) and post-processed in MATLAB for Simulink execution.
- Supports smooth trajectory resampling and filtering to remove temporal artifacts due to simulation rate mismatch.

### 5. Batch Testing and Result Analysis
- Automated randomized simulations (`runBatchTests.m`, `runBallbotSimulation.m`) to test robustness under varying parameters.
- Results are saved as `.mat` files and analyzed using the provided `analyze_results` tools.
- Generation of correlation tables, performance metrics (RMSE, MAE, tilt angles), and comparative plots between controllers.

---

## üìÅ Repository Structure

Below is an overview of the main folders and scripts included in this repository, along with their roles in the project.

### `OL_generated_eq/`
Contains MATLAB scripts implementing the **open-loop dynamic model** of the ballbot without any control or manipulator.  
These simulations reproduce the system‚Äôs natural inverted-pendulum behavior and are used to validate the analytical equations derived from the Lagrangian formulation.

### `PID_LQR_PI/`
Includes the **cascaded LQR‚ÄìPI controller** used for closed-loop control of the ballbot base.  
This module allows tuning of the LQR and PI gains and evaluation of controller performance in ideal, disturbance-free conditions.

### `manipulator_sim/`
Provides the **Simscape Multibody model** of the UR5e manipulator and the Robotiq 2F-85 gripper, imported from the URDF description.  
The manipulator is dynamically coupled to the ballbot base through Cartesian and spherical joints to ensure consistent kinematics and inertial behavior.

### `Planning_sim/`
Main orchestration script for **complete navigation and manipulation simulations**.  
It performs:
- Path planning and trajectory generation using **RRT\***.  
- Velocity profile computation and reference generation.  
- Execution of the Simulink model `scheme_pos_control_yawcontrol`, which handles navigation, yaw control, and task sequencing.  
After reaching the goal position, the script automatically triggers the manipulation phase.  
It can optionally be configured to use `scheme_fullbodycontrol` for experimental full-body control simulations.

### `Planning_w_Adaptive/`
Contains simulation setups for the **adaptive MRAC controller**, focusing solely on the mobile base.  
Used to evaluate the controller‚Äôs ability to adapt to parameter uncertainties and compensate for external disturbances.

### `runBatchTests.m` and `runBallbotSimulation.m`
Utility scripts to perform **batch simulations** under randomized conditions (e.g., payload variations, initial tilt, friction coefficients).  
Each run is automatically saved as a `.mat` file for later statistical and performance analysis.

### `analyze_results/`
Provides **data analysis and visualization tools** for processing the results of batch simulations.  
Includes scripts for computing performance metrics, correlation tables, and reproducing the figures and statistics presented in the report.

### `ros2_moveit_integration/`
Contains the ROS 2 integration modules used to connect MATLAB/Simulink with **MoveIt Task Constructor (MTC)**.  
Includes:
- Nodes for publishing symbolic HTN plans.  
- Launch files for executing MTC task sequences.  
- Tools for exporting joint-space trajectories via rosbag for post-processing and playback in MATLAB.

---

---

## ‚ñ∂Ô∏è How to Run Simulations

1. **Open-loop model validation**  
   Run scripts in `OL_generated_eq/` to simulate the ballbot without any controller and observe its unstable inverted-pendulum behavior.

2. **Controlled ballbot (no manipulator)**  
   Open and run the Simulink models in `PID_LQR_PI/` to test the cascaded LQR‚ÄìPI control architecture.

3. **Full navigation and manipulation**  
   Run the script `Planning_sim.m` to execute the complete scenario:
   - Path planning and velocity profiling.
   - Simulink model `scheme_pos_control_yawcontrol` execution.
   - Trigger manipulation sequence at the target position.

4. **Adaptive control testing**  
   Run `Planning_w_Adaptive.m` to validate MRAC controller performance.

5. **Batch experiments and analysis**  
   Launch `runBatchTests.m` to automatically test multiple parameter configurations.  
   Once complete, open `analyze_results/` to visualize results and correlation metrics.

---

## üß© Key Simulink Models


- **`scheme_pos_control_yawcontrol`** ‚Äî main simulation model integrating navigation, yaw control, and task-switch logic for manipulation.  
- **`scheme_fullbodycontrol`** ‚Äî experimental model for coupling manipulator and base dynamics in a unified controller (currently not fully functional).  
- **`scheme_w_Adaptive`** ‚Äî used for MRAC-based base control simulations.

---

## üìä Result Files and Visualization

All `.mat` files generated by batch simulations contain:
- Trajectories, state histories, and torque signals.
- Performance indicators (RMSE, MAE, mean/max tilt).
- Controller configuration metadata.

These can be loaded in MATLAB and analyzed through the provided functions in `analyze_results/`, which produce tables and plots comparing:
- Controller types (LQR‚ÄìPI, MRAC, hybrid).
- Tilt response and tracking error.
- Correlations between gains and performance.

---

## üß† Notes on Controllers and Algorithms

### RRT\* Planning
- Planner operates on a 2D occupancy map with obstacle inflation.
- Parameters: connection distance, maximum iterations, and smoothing factor.
- The planner produces a collision-free path used as reference for velocity profiling.

### Velocity Profiling
- Generates smooth trapezoidal or triangular speed profiles along the path.
- Incorporates lookahead feedback to improve trajectory tracking.
- Comparison of different lookahead distances is available in the analysis results.

### Cascade LQR‚ÄìPI
- The outer LQR computes a model-based torque reference.
- The inner PI ensures tracking of sphere velocity and compensates modeling errors.
- Provides stable and accurate tracking with low steady-state error.

### MRAC (Model Reference Adaptive Control)
- Adjusts control gains in real-time using adaptive laws.
- Provides robustness to parametric uncertainty and external disturbances.
- Must be carefully tuned to avoid excessive torque transients.

### Manipulation Integration
- The manipulator‚Äôs dynamics are treated as an external wrench applied to the base.
- Vertical loads are compensated separately to avoid instability.
- Operational-space compensation was tested but revealed strong coupling effects ‚Äî a true full-body controller would be required for optimal results.

---

## ‚ö†Ô∏è Known Issues and Limitations
- The **MRAC controller** may produce large transient torques; initial references should be smoothed.  
- The **full-body control scheme** is experimental and not yet stable.  
- Time synchronization between ROS and MATLAB simulations can introduce minor trajectory misalignments if rosbag data is not post-processed.  
- The Simscape manipulator model requires manual fixing of **mimic joints** for the gripper.

---

## üßæ Credits

Developed by **Roberto Rocco** and **Chiara Panagrosso** as part of the Master‚Äôs project in *Automation and Robotics Engineering* at the **University of Naples Federico II**.

For further details and theoretical background, see the attached report:  
**FSR_Project_Rocco_Panagrosso.pdf**

### üìö Contribution Summary

**Chapter 2 ‚Äî System Modeling and Dynamics**  
*Chiara*: Derived and validated the mathematical model of the ballbot and analyzed the system‚Äôs dynamic behavior.

**Chapter 3 ‚Äî Planning and Trajectory Generation**  
*Chiara*: Implemented geometric path planning (RRT\*) and manipulator trajectory generation using MoveIt Task Constructor.  
*Roberto*: Developed the velocity trajectory generation module and path-following logic for the mobile base.

**Chapter 4 ‚Äî Control Architectures**  
*Chiara*: Designed and tested the Model Reference Adaptive Control (MRAC) strategy for the ballbot base.  
*Roberto*: Implemented and tuned the LQR and cascaded LQR‚ÄìPI control architectures.

**Chapter 5 ‚Äî Hybrid Control and Interaction**  
*Chiara*: Modeled the external interaction between manipulator and base, implemented yaw control and the compensation module.  
*Roberto*: Developed the hybrid control logic, defined operational phases, tuned parameters, and implemented the operational-space feedback compensation.


---

## License
This project is released for academic and research purposes only.  
Reproduction or modification is permitted with proper attribution.

